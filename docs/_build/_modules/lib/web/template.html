

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>lib.web.template &mdash; Change by Us v2.0-alpha documentation</title>
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.0-alpha',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Change by Us v2.0-alpha documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Change by Us v2.0-alpha documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for lib.web.template</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">simple, elegant templating</span>
<span class="sd">(part of web.py)</span>

<span class="sd">Template design:</span>

<span class="sd">Template string is split into tokens and the tokens are combined into nodes. </span>
<span class="sd">Parse tree is a nodelist. TextNode and ExpressionNode are simple nodes and </span>
<span class="sd">for-loop, if-loop etc are block nodes, which contain multiple child nodes. </span>

<span class="sd">Each node can emit some python string. python string emitted by the </span>
<span class="sd">root node is validated for safeeval and executed using python in the given environment.</span>

<span class="sd">Enough care is taken to make sure the generated code and the template has line to line match, </span>
<span class="sd">so that the error messages can point to exact line number in template. (It doesn&#39;t work in some cases still.)</span>

<span class="sd">Grammar:</span>

<span class="sd">    template -&gt; defwith sections </span>
<span class="sd">    defwith -&gt; &#39;$def with (&#39; arguments &#39;)&#39; | &#39;&#39;</span>
<span class="sd">    sections -&gt; section*</span>
<span class="sd">    section -&gt; block | assignment | line</span>

<span class="sd">    assignment -&gt; &#39;$ &#39; &lt;assignment expression&gt;</span>
<span class="sd">    line -&gt; (text|expr)*</span>
<span class="sd">    text -&gt; &lt;any characters other than $&gt;</span>
<span class="sd">    expr -&gt; &#39;$&#39; pyexpr | &#39;$(&#39; pyexpr &#39;)&#39; | &#39;${&#39; pyexpr &#39;}&#39;</span>
<span class="sd">    pyexpr -&gt; &lt;python expression&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;Template&quot;</span><span class="p">,</span>
    <span class="s">&quot;Render&quot;</span><span class="p">,</span> <span class="s">&quot;render&quot;</span><span class="p">,</span> <span class="s">&quot;frender&quot;</span><span class="p">,</span>
    <span class="s">&quot;ParseError&quot;</span><span class="p">,</span> <span class="s">&quot;SecurityError&quot;</span><span class="p">,</span>
    <span class="s">&quot;test&quot;</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">tokenize</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">UserDict</span> <span class="kn">import</span> <span class="n">DictMixin</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">storage</span><span class="p">,</span> <span class="n">safeunicode</span><span class="p">,</span> <span class="n">safestr</span><span class="p">,</span> <span class="n">re_compile</span>
<span class="kn">from</span> <span class="nn">webapi</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">net</span> <span class="kn">import</span> <span class="n">websafe</span>

<span class="k">def</span> <span class="nf">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Splits the given text at newline.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; splitline(&#39;foo\nbar&#39;)</span>
<span class="sd">        (&#39;foo\n&#39;, &#39;bar&#39;)</span>
<span class="sd">        &gt;&gt;&gt; splitline(&#39;foo&#39;)</span>
<span class="sd">        (&#39;foo&#39;, &#39;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; splitline(&#39;&#39;)</span>
<span class="sd">        (&#39;&#39;, &#39;&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">[:</span><span class="n">index</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="s">&#39;&#39;</span>

<span class="k">class</span> <span class="nc">Parser</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parser Base.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statement_nodes</span> <span class="o">=</span> <span class="n">STATEMENT_NODES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">KEYWORDS</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;&lt;template&gt;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">defwith</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_defwith</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">suite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_suite</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DefwithNode</span><span class="p">(</span><span class="n">defwith</span><span class="p">,</span> <span class="n">suite</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_defwith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;$def with&#39;</span><span class="p">):</span>
            <span class="n">defwith</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">defwith</span> <span class="o">=</span> <span class="n">defwith</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c"># strip $ and spaces</span>
            <span class="k">return</span> <span class="n">defwith</span><span class="p">,</span> <span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span>
    
    <span class="k">def</span> <span class="nf">read_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reads one section from the given text.</span>
<span class="sd">        </span>
<span class="sd">        section -&gt; block | assignment | line</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; read_section = Parser().read_section</span>
<span class="sd">            &gt;&gt;&gt; read_section(&#39;foo\nbar\n&#39;)</span>
<span class="sd">            (&lt;line: [t&#39;foo\n&#39;]&gt;, &#39;bar\n&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_section(&#39;$ a = b + 1\nfoo\n&#39;)</span>
<span class="sd">            (&lt;assignment: &#39;a = b + 1&#39;&gt;, &#39;foo\n&#39;)</span>
<span class="sd">            </span>
<span class="sd">        read_section(&#39;$for in range(10):\n    hello $i\nfoo)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">)</span>
            <span class="n">begin_indent</span><span class="p">,</span> <span class="n">text2</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">index</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">ahead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_lookahead</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">ahead</span> <span class="o">==</span> <span class="s">&#39;var&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_var</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ahead</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement_nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_block_section</span><span class="p">(</span><span class="n">text2</span><span class="p">,</span> <span class="n">begin_indent</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ahead</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_keyword</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ahead</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="c"># assignments starts with a space after $</span>
                <span class="c"># ex: $ a = b + 2</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_assignment</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">read_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reads a var statement.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; read_var = Parser().read_var</span>
<span class="sd">            &gt;&gt;&gt; read_var(&#39;var x=10\nfoo&#39;)</span>
<span class="sd">            (&lt;var: x = 10&gt;, &#39;foo&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_var(&#39;var x: hello $name\nfoo&#39;)</span>
<span class="sd">            (&lt;var: x = join_(u&#39;hello &#39;, escape_(name, True))&gt;, &#39;foo&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_tokens</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s">&#39;Invalid var statement&#39;</span><span class="p">)</span>
            
        <span class="n">name</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">sep</span> <span class="o">==</span> <span class="s">&#39;=&#39;</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># no need to process value</span>
        <span class="k">elif</span> <span class="n">sep</span> <span class="o">==</span> <span class="s">&#39;:&#39;</span><span class="p">:</span> 
            <span class="c">#@@ Hack for backward-compatability</span>
            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span> <span class="c"># multi-line var statement</span>
                <span class="n">block</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_indented_block</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s">&#39;    &#39;</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TextNode</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>         
            <span class="k">else</span><span class="p">:</span> <span class="c"># single-line var statement</span>
                <span class="n">linenode</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">linenode</span><span class="o">.</span><span class="n">nodes</span>                
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;join_(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s">&#39;Invalid var statement&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">VarNode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">text</span>
                    
    <span class="k">def</span> <span class="nf">read_suite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reads section by section till end of text.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; read_suite = Parser().read_suite</span>
<span class="sd">            &gt;&gt;&gt; read_suite(&#39;hello $name\nfoo\n&#39;)</span>
<span class="sd">            [&lt;line: [t&#39;hello &#39;, $name, t&#39;\n&#39;]&gt;, &lt;line: [t&#39;foo\n&#39;]&gt;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">section</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_section</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SuiteNode</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reads one line from the text. Newline is supressed if the line ends with \.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; readline = Parser().readline</span>
<span class="sd">            &gt;&gt;&gt; readline(&#39;hello $name!\nbye!&#39;)</span>
<span class="sd">            (&lt;line: [t&#39;hello &#39;, $name, t&#39;!\n&#39;]&gt;, &#39;bye!&#39;)</span>
<span class="sd">            &gt;&gt;&gt; readline(&#39;hello $name!\\\nbye!&#39;)</span>
<span class="sd">            (&lt;line: [t&#39;hello &#39;, $name, t&#39;!&#39;]&gt;, &#39;bye!&#39;)</span>
<span class="sd">            &gt;&gt;&gt; readline(&#39;$f()\n\n&#39;)</span>
<span class="sd">            (&lt;line: [$f(), t&#39;\n&#39;]&gt;, &#39;\n&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c"># supress new line if line ends with \</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">LineNode</span><span class="p">(</span><span class="n">nodes</span><span class="p">),</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">read_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reads a node from the given text and returns the node and remaining text.</span>

<span class="sd">            &gt;&gt;&gt; read_node = Parser().read_node</span>
<span class="sd">            &gt;&gt;&gt; read_node(&#39;hello $name&#39;)</span>
<span class="sd">            (t&#39;hello &#39;, &#39;$name&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_node(&#39;$name&#39;)</span>
<span class="sd">            ($name, &#39;&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;$$&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">TextNode</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">),</span> <span class="n">text</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;$#&#39;</span><span class="p">):</span> <span class="c"># comment</span>
            <span class="n">line</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TextNode</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">text</span>
        <span class="k">elif</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c"># strip $</span>
            <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">):</span>
                <span class="n">escape</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c"># strip :</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">escape</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_expr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="n">escape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">read_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reads a text node from the given text.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; read_text = Parser().read_text</span>
<span class="sd">            &gt;&gt;&gt; read_text(&#39;hello $name&#39;)</span>
<span class="sd">            (t&#39;hello &#39;, &#39;$name&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TextNode</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TextNode</span><span class="p">(</span><span class="n">text</span><span class="p">[:</span><span class="n">index</span><span class="p">]),</span> <span class="n">text</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
            
    <span class="k">def</span> <span class="nf">read_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">StatementNode</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">read_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a python expression from the text and returns the expression and remaining text.</span>

<span class="sd">        expr -&gt; simple_expr | paren_expr</span>
<span class="sd">        simple_expr -&gt; id extended_expr</span>
<span class="sd">        extended_expr -&gt; attr_access | paren_expr extended_expr | &#39;&#39;</span>
<span class="sd">        attr_access -&gt; dot id extended_expr</span>
<span class="sd">        paren_expr -&gt; [ tokens ] | ( tokens ) | { tokens }</span>
<span class="sd">     </span>
<span class="sd">            &gt;&gt;&gt; read_expr = Parser().read_expr</span>
<span class="sd">            &gt;&gt;&gt; read_expr(&quot;name&quot;)</span>
<span class="sd">            ($name, &#39;&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_expr(&quot;a.b and c&quot;)</span>
<span class="sd">            ($a.b, &#39; and c&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_expr(&quot;a. b&quot;)</span>
<span class="sd">            ($a, &#39;. b&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_expr(&quot;name&lt;/h1&gt;&quot;)</span>
<span class="sd">            ($name, &#39;&lt;/h1&gt;&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_expr(&quot;(limit)ing&quot;)</span>
<span class="sd">            ($(limit), &#39;ing&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_expr(&#39;a[1, 2][:3].f(1+2, &quot;weird string[).&quot;, 3 + 4) done.&#39;)</span>
<span class="sd">            ($a[1, 2][:3].f(1+2, &quot;weird string[).&quot;, 3 + 4), &#39; done.&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">simple_expr</span><span class="p">():</span>
            <span class="n">identifier</span><span class="p">()</span>
            <span class="n">extended_expr</span><span class="p">()</span>
        
        <span class="k">def</span> <span class="nf">identifier</span><span class="p">():</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        
        <span class="k">def</span> <span class="nf">extended_expr</span><span class="p">():</span>
            <span class="n">lookahead</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">lookahead</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lookahead</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">lookahead</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">attr_access</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">lookahead</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">parens</span><span class="p">:</span>
                <span class="n">paren_expr</span><span class="p">()</span>
                <span class="n">extended_expr</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        
        <span class="k">def</span> <span class="nf">attr_access</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">token</span> <span class="kn">import</span> <span class="n">NAME</span> <span class="c"># python token constants</span>
            <span class="n">dot</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">lookahead</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tokens</span><span class="o">.</span><span class="n">lookahead2</span><span class="p">()</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NAME</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="c"># consume dot</span>
                <span class="n">identifier</span><span class="p">()</span>
                <span class="n">extended_expr</span><span class="p">()</span>
        
        <span class="k">def</span> <span class="nf">paren_expr</span><span class="p">():</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">parens</span><span class="p">[</span><span class="n">begin</span><span class="p">]</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tokens</span><span class="o">.</span><span class="n">lookahead</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">parens</span><span class="p">:</span>
                    <span class="n">paren_expr</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">return</span>

        <span class="n">parens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;(&quot;</span><span class="p">:</span> <span class="s">&quot;)&quot;</span><span class="p">,</span>
            <span class="s">&quot;[&quot;</span><span class="p">:</span> <span class="s">&quot;]&quot;</span><span class="p">,</span>
            <span class="s">&quot;{&quot;</span><span class="p">:</span> <span class="s">&quot;}&quot;</span>
        <span class="p">}</span>
        
        <span class="k">def</span> <span class="nf">get_tokens</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;tokenize text using python tokenizer.</span>
<span class="sd">            Python tokenizer ignores spaces, but they might be important in some cases. </span>
<span class="sd">            This function introduces dummy space tokens when it identifies any ignored space.</span>
<span class="sd">            Each token is a storage object containing type, value, begin and end.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">readline</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([</span><span class="n">text</span><span class="p">])</span><span class="o">.</span><span class="n">next</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">readline</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">storage</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">begin</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">!=</span> <span class="n">t</span><span class="o">.</span><span class="n">begin</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">end</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">begin</span>
                    <span class="k">yield</span> <span class="n">storage</span><span class="p">(</span><span class="nb">type</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">text</span><span class="p">[</span><span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">],</span> <span class="n">begin</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">begin</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">end</span>
                <span class="k">yield</span> <span class="n">t</span>
                
        <span class="k">class</span> <span class="nc">BetterIter</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Iterator like object with 2 support for 2 look aheads.&quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_item</span> <span class="o">=</span> <span class="bp">None</span>
            
            <span class="k">def</span> <span class="nf">lookahead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next</span><span class="p">())</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>

            <span class="k">def</span> <span class="nf">_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                
            <span class="k">def</span> <span class="nf">lookahead2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next</span><span class="p">())</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    
            <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookahead</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_item</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">BetterIter</span><span class="p">(</span><span class="n">get_tokens</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
                
        <span class="k">if</span> <span class="n">tokens</span><span class="o">.</span><span class="n">lookahead</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">parens</span><span class="p">:</span>
            <span class="n">paren_expr</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">simple_expr</span><span class="p">()</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">current_item</span><span class="o">.</span><span class="n">end</span>
        <span class="k">return</span> <span class="n">ExpressionNode</span><span class="p">(</span><span class="n">text</span><span class="p">[:</span><span class="n">col</span><span class="p">],</span> <span class="n">escape</span><span class="o">=</span><span class="n">escape</span><span class="p">),</span> <span class="n">text</span><span class="p">[</span><span class="n">col</span><span class="p">:]</span>    

    <span class="k">def</span> <span class="nf">read_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reads assignment statement from text.</span>
<span class="sd">    </span>
<span class="sd">            &gt;&gt;&gt; read_assignment = Parser().read_assignment</span>
<span class="sd">            &gt;&gt;&gt; read_assignment(&#39;a = b + 1\nfoo&#39;)</span>
<span class="sd">            (&lt;assignment: &#39;a = b + 1&#39;&gt;, &#39;foo&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AssignmentNode</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="n">text</span>
    
    <span class="k">def</span> <span class="nf">python_lookahead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the first python token from the given text.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; python_lookahead = Parser().python_lookahead</span>
<span class="sd">            &gt;&gt;&gt; python_lookahead(&#39;for i in range(10):&#39;)</span>
<span class="sd">            &#39;for&#39;</span>
<span class="sd">            &gt;&gt;&gt; python_lookahead(&#39;else:&#39;)</span>
<span class="sd">            &#39;else&#39;</span>
<span class="sd">            &gt;&gt;&gt; python_lookahead(&#39; x = 1&#39;)</span>
<span class="sd">            &#39; &#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">readline</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([</span><span class="n">text</span><span class="p">])</span><span class="o">.</span><span class="n">next</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">readline</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tokens</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">python_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">readline</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([</span><span class="n">text</span><span class="p">])</span><span class="o">.</span><span class="n">next</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">readline</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">read_indented_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Read a block of text. A block is what typically follows a for or it statement.</span>
<span class="sd">        It can be in the same line as that of the statement or an indented block.</span>

<span class="sd">            &gt;&gt;&gt; read_indented_block = Parser().read_indented_block</span>
<span class="sd">            &gt;&gt;&gt; read_indented_block(&#39;  a\n  b\nc&#39;, &#39;  &#39;)</span>
<span class="sd">            (&#39;a\nb\n&#39;, &#39;c&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_indented_block(&#39;  a\n    b\n  c\nd&#39;, &#39;  &#39;)</span>
<span class="sd">            (&#39;a\n  b\nc\n&#39;, &#39;d&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_indented_block(&#39;  a\n\n    b\nc&#39;, &#39;  &#39;)</span>
<span class="sd">            (&#39;a\n\n  b\n&#39;, &#39;c&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">indent</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span>
            
        <span class="n">block</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">line</span><span class="p">,</span> <span class="n">text2</span> <span class="o">=</span> <span class="n">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">block</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">indent</span><span class="p">):</span>
                <span class="n">block</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">):]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text2</span>
        <span class="k">return</span> <span class="n">block</span><span class="p">,</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">read_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reads a python statement.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; read_statement = Parser().read_statement</span>
<span class="sd">            &gt;&gt;&gt; read_statement(&#39;for i in range(10): hello $name&#39;)</span>
<span class="sd">            (&#39;for i in range(10):&#39;, &#39; hello $name&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="n">PythonTokenizer</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">tok</span><span class="o">.</span><span class="n">consume_till</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">[:</span><span class="n">tok</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">index</span><span class="p">:]</span>
        
    <span class="k">def</span> <span class="nf">read_block_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">begin_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">            &gt;&gt;&gt; read_block_section = Parser().read_block_section</span>
<span class="sd">            &gt;&gt;&gt; read_block_section(&#39;for i in range(10): hello $i\nfoo&#39;)</span>
<span class="sd">            (&lt;block: &#39;for i in range(10):&#39;, [&lt;line: [t&#39;hello &#39;, $i, t&#39;\n&#39;]&gt;]&gt;, &#39;foo&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_block_section(&#39;for i in range(10):\n        hello $i\n    foo&#39;, begin_indent=&#39;    &#39;)</span>
<span class="sd">            (&lt;block: &#39;for i in range(10):&#39;, [&lt;line: [t&#39;hello &#39;, $i, t&#39;\n&#39;]&gt;]&gt;, &#39;    foo&#39;)</span>
<span class="sd">            &gt;&gt;&gt; read_block_section(&#39;for i in range(10):\n  hello $i\nfoo&#39;)</span>
<span class="sd">            (&lt;block: &#39;for i in range(10):&#39;, [&lt;line: [t&#39;hello &#39;, $i, t&#39;\n&#39;]&gt;]&gt;, &#39;foo&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">splitline</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">stmt</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_statement</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_lookahead</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        
        <span class="c"># if there is some thing left in the line</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">find_indent</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="n">rx</span> <span class="o">=</span> <span class="n">re_compile</span><span class="p">(</span><span class="s">&#39;  +&#39;</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>    
                <span class="n">first_indent</span> <span class="o">=</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">first_indent</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>

            <span class="c"># find the indentation of the block by looking at the first line</span>
            <span class="n">first_indent</span> <span class="o">=</span> <span class="n">find_indent</span><span class="p">(</span><span class="n">text</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">begin_indent</span><span class="p">):]</span>

            <span class="c">#TODO: fix this special case</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s">&quot;code&quot;</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="n">begin_indent</span> <span class="o">+</span> <span class="n">first_indent</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="n">begin_indent</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">first_indent</span><span class="p">,</span> <span class="n">INDENT</span><span class="p">)</span>
            
            <span class="n">block</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_indented_block</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_block_node</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">begin_indent</span><span class="p">),</span> <span class="n">text</span>
        
    <span class="k">def</span> <span class="nf">create_block_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">begin_indent</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement_nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement_nodes</span><span class="p">[</span><span class="n">keyword</span><span class="p">](</span><span class="n">stmt</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">begin_indent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParseError</span><span class="p">,</span> <span class="s">&#39;Unknown statement: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">PythonTokenizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Utility wrapper over python tokenizer.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">readline</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([</span><span class="n">text</span><span class="p">])</span><span class="o">.</span><span class="n">next</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">readline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">consume_till</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delim</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;Consumes tokens till colon.</span>
<span class="sd">        </span>
<span class="sd">            &gt;&gt;&gt; tok = PythonTokenizer(&#39;for i in range(10): hello $i&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tok.consume_till(&#39;:&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tok.text[:tok.index]</span>
<span class="sd">            &#39;for i in range(10):&#39;</span>
<span class="sd">            &gt;&gt;&gt; tok.text[tok.index:]</span>
<span class="sd">            &#39; hello $i&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">delim</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">consume_till</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;[&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">consume_till</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">consume_till</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>

                <span class="c"># if end of line is found, it is an exception.</span>
                <span class="c"># Since there is no easy way to report the line number,</span>
                <span class="c"># leave the error reporting to the python parser later  </span>
                <span class="c">#@@ This should be fixed.</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c">#raise ParseError, &quot;Expected %s, found end of line.&quot; % repr(delim)</span>

            <span class="c"># raising ParseError doesn&#39;t show the line number. </span>
            <span class="c"># if this error is ignored, then it will be caught when compiling the python code.</span>
            <span class="k">return</span>
    
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">col</span>
        <span class="k">return</span> <span class="n">storage</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">DefwithNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defwith</span><span class="p">,</span> <span class="n">suite</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">defwith</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defwith</span> <span class="o">=</span> <span class="n">defwith</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;with&#39;</span><span class="p">,</span> <span class="s">&#39;__template__&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span>
            <span class="c"># offset 4 lines. for encoding, __lineoffset__, loop and self.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defwith</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">    __lineoffset__ = -4&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defwith</span> <span class="o">=</span> <span class="s">&#39;def __template__():&#39;</span>
            <span class="c"># offset 4 lines for encoding, __template__, __lineoffset__, loop and self.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defwith</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">    __lineoffset__ = -5&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defwith</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">    loop = ForLoop()&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defwith</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">    self = TemplateResult(); extend_ = self.extend&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suite</span> <span class="o">=</span> <span class="n">suite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">    return self&quot;</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="s">&quot;# coding: utf-8</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">encoding</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">defwith</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">INDENT</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;defwith: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defwith</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TextNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">begin_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">safeunicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;t&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ExpressionNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c"># convert ${...} to $(...)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#39;(&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">escape</span> <span class="o">=</span> <span class="n">escape</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">begin_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;escape_(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="p">:</span>
            <span class="n">escape</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">escape</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span>
        <span class="k">return</span> <span class="s">&quot;$</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">escape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">AssignmentNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">begin_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">indent</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;assignment: </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">LineNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">text_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">text_indent</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">text_indent</span><span class="p">)]</span> <span class="o">+</span> <span class="n">text</span>

        <span class="k">return</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;extend_([</span><span class="si">%s</span><span class="s">])</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;line: </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

<span class="n">INDENT</span> <span class="o">=</span> <span class="s">&#39;    &#39;</span> <span class="c"># 4 spaces</span>
        
<span class="k">class</span> <span class="nc">BlockNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">begin_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suite</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">()</span><span class="o">.</span><span class="n">read_suite</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_indent</span> <span class="o">=</span> <span class="n">begin_indent</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">text_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">text_indent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_indent</span> <span class="o">+</span> <span class="n">text_indent</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stmt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">INDENT</span><span class="p">,</span> <span class="n">text_indent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;block: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stmt</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">ForNode</span><span class="p">(</span><span class="n">BlockNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">begin_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_stmt</span> <span class="o">=</span> <span class="n">stmt</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="n">PythonTokenizer</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">tok</span><span class="o">.</span><span class="n">consume_till</span><span class="p">(</span><span class="s">&#39;in&#39;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">stmt</span><span class="p">[:</span><span class="n">tok</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="c"># for i in</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">stmt</span><span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">index</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c"># rest of for stmt excluding :</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="s">&#39; loop.setup(&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;):&#39;</span>
        <span class="n">BlockNode</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">begin_indent</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;block: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_stmt</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">CodeNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">begin_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="c"># compensate one line for $code:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">block</span>
        
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">text_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rx</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;code: </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">StatementNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">begin_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">indent</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stmt</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;stmt: </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stmt</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">IfNode</span><span class="p">(</span><span class="n">BlockNode</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ElseNode</span><span class="p">(</span><span class="n">BlockNode</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ElifNode</span><span class="p">(</span><span class="n">BlockNode</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">DefNode</span><span class="p">(</span><span class="n">BlockNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">BlockNode</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">CodeNode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">code</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;self = TemplateResult(); extend_ = self.extend</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">CodeNode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">code</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;return self</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">text_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">text_indent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_indent</span> <span class="o">+</span> <span class="n">text_indent</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stmt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">INDENT</span><span class="p">,</span> <span class="n">text_indent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;__lineoffset__ -= 3</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">VarNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">text_indent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;self[</span><span class="si">%s</span><span class="s">] = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;var: </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SuiteNode</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Suite is a list of sections.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sections</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="n">sections</span>
        
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">text_indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">text_indent</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span>

<span class="n">STATEMENT_NODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;for&#39;</span><span class="p">:</span> <span class="n">ForNode</span><span class="p">,</span>
    <span class="s">&#39;while&#39;</span><span class="p">:</span> <span class="n">BlockNode</span><span class="p">,</span>
    <span class="s">&#39;if&#39;</span><span class="p">:</span> <span class="n">IfNode</span><span class="p">,</span>
    <span class="s">&#39;elif&#39;</span><span class="p">:</span> <span class="n">ElifNode</span><span class="p">,</span>
    <span class="s">&#39;else&#39;</span><span class="p">:</span> <span class="n">ElseNode</span><span class="p">,</span>
    <span class="s">&#39;def&#39;</span><span class="p">:</span> <span class="n">DefNode</span><span class="p">,</span>
    <span class="s">&#39;code&#39;</span><span class="p">:</span> <span class="n">CodeNode</span>
<span class="p">}</span>

<span class="n">KEYWORDS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;pass&quot;</span><span class="p">,</span>
    <span class="s">&quot;break&quot;</span><span class="p">,</span>
    <span class="s">&quot;continue&quot;</span><span class="p">,</span>
    <span class="s">&quot;return&quot;</span>
<span class="p">]</span>

<span class="n">TEMPLATE_BUILTIN_NAMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;dict&quot;</span><span class="p">,</span> <span class="s">&quot;enumerate&quot;</span><span class="p">,</span> <span class="s">&quot;float&quot;</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="s">&quot;bool&quot;</span><span class="p">,</span> <span class="s">&quot;list&quot;</span><span class="p">,</span> <span class="s">&quot;long&quot;</span><span class="p">,</span> <span class="s">&quot;reversed&quot;</span><span class="p">,</span> 
    <span class="s">&quot;set&quot;</span><span class="p">,</span> <span class="s">&quot;slice&quot;</span><span class="p">,</span> <span class="s">&quot;tuple&quot;</span><span class="p">,</span> <span class="s">&quot;xrange&quot;</span><span class="p">,</span>
    <span class="s">&quot;abs&quot;</span><span class="p">,</span> <span class="s">&quot;all&quot;</span><span class="p">,</span> <span class="s">&quot;any&quot;</span><span class="p">,</span> <span class="s">&quot;callable&quot;</span><span class="p">,</span> <span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;cmp&quot;</span><span class="p">,</span> <span class="s">&quot;divmod&quot;</span><span class="p">,</span> <span class="s">&quot;filter&quot;</span><span class="p">,</span> <span class="s">&quot;hex&quot;</span><span class="p">,</span> 
    <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;isinstance&quot;</span><span class="p">,</span> <span class="s">&quot;iter&quot;</span><span class="p">,</span> <span class="s">&quot;len&quot;</span><span class="p">,</span> <span class="s">&quot;max&quot;</span><span class="p">,</span> <span class="s">&quot;min&quot;</span><span class="p">,</span> <span class="s">&quot;oct&quot;</span><span class="p">,</span> <span class="s">&quot;ord&quot;</span><span class="p">,</span> <span class="s">&quot;pow&quot;</span><span class="p">,</span> <span class="s">&quot;range&quot;</span><span class="p">,</span>
    <span class="s">&quot;True&quot;</span><span class="p">,</span> <span class="s">&quot;False&quot;</span><span class="p">,</span>
    <span class="s">&quot;None&quot;</span><span class="p">,</span>
    <span class="s">&quot;__import__&quot;</span><span class="p">,</span> <span class="c"># some c-libraries like datetime requires __import__ to present in the namespace</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">__builtin__</span>
<span class="n">TEMPLATE_BUILTINS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__builtin__</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">TEMPLATE_BUILTIN_NAMES</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">__dict__</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ForLoop</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for expression in for stament to support loop.xxx helpers.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; loop = ForLoop()</span>
<span class="sd">        &gt;&gt;&gt; for x in loop.setup([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]):</span>
<span class="sd">        ...     print loop.index, loop.revindex, loop.parity, x</span>
<span class="sd">        ...</span>
<span class="sd">        1 3 odd a</span>
<span class="sd">        2 2 even b</span>
<span class="sd">        3 1 odd c</span>
<span class="sd">        &gt;&gt;&gt; loop.index</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        AttributeError: index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">None</span>
        
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_push</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_push</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="n">ForLoopContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="n">parent</span>
                
<span class="k">class</span> <span class="nc">ForLoopContext</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Stackable context for ForLoop to support nested for loops.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forloop</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forloop</span> <span class="o">=</span> <span class="n">forloop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">yield</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forloop</span><span class="o">.</span><span class="n">_pop</span><span class="p">()</span>
            
    <span class="n">index0</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">first</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">last</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
    <span class="n">odd</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">even</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">parity</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;odd&#39;</span><span class="p">,</span> <span class="s">&#39;even&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">even</span><span class="p">])</span>
    <span class="n">revindex0</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">revindex</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">BaseTemplate</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="n">builtins</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_globals</span> <span class="o">=</span> <span class="nb">globals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_builtins</span> <span class="o">=</span> <span class="n">builtins</span>
        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
        
    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globals</span> <span class="ow">or</span> <span class="p">{},</span> <span class="bp">self</span><span class="o">.</span><span class="n">_builtins</span><span class="p">)</span>
        <span class="k">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="s">&#39;__template__&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">__hidetraceback__</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="n">builtins</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">,</span>
            <span class="n">__builtins__</span><span class="o">=</span><span class="n">builtins</span><span class="p">,</span> 
            <span class="n">ForLoop</span><span class="o">=</span><span class="n">ForLoop</span><span class="p">,</span>
            <span class="n">TemplateResult</span><span class="o">=</span><span class="n">TemplateResult</span><span class="p">,</span>
            <span class="n">escape_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_escape</span><span class="p">,</span>
            <span class="n">join_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_join</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">u&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_escape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
            <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            
        <span class="n">value</span> <span class="o">=</span> <span class="n">safeunicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">escape</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="Template"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.Template">[docs]</a><span class="k">class</span> <span class="nc">Template</span><span class="p">(</span><span class="n">BaseTemplate</span><span class="p">):</span>
    <span class="n">CONTENT_TYPES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;.html&#39;</span> <span class="p">:</span> <span class="s">&#39;text/html; charset=utf-8&#39;</span><span class="p">,</span>
        <span class="s">&#39;.xhtml&#39;</span> <span class="p">:</span> <span class="s">&#39;application/xhtml+xml; charset=utf-8&#39;</span><span class="p">,</span>
        <span class="s">&#39;.txt&#39;</span> <span class="p">:</span> <span class="s">&#39;text/plain&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">FILTERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;.html&#39;</span><span class="p">:</span> <span class="n">websafe</span><span class="p">,</span>
        <span class="s">&#39;.xhtml&#39;</span><span class="p">:</span> <span class="n">websafe</span><span class="p">,</span>
        <span class="s">&#39;.xml&#39;</span><span class="p">:</span> <span class="n">websafe</span>
    <span class="p">}</span>
    <span class="nb">globals</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s">&#39;&lt;template&gt;&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">builtins</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="n">extensions</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">Template</span><span class="o">.</span><span class="n">normalize_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="nb">filter</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILTERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTENT_TYPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">globals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span>
        <span class="k">if</span> <span class="n">builtins</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">builtins</span> <span class="o">=</span> <span class="n">TEMPLATE_BUILTINS</span>
                
        <span class="n">BaseTemplate</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="nb">globals</span><span class="p">,</span> <span class="n">builtins</span><span class="o">=</span><span class="n">builtins</span><span class="p">)</span>
        
<div class="viewcode-block" id="Template.normalize_text"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.Template.normalize_text">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalizes template text by correcting \r\n, tabs and BOM chars.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="c"># ignore BOM chars at the begining of template</span>
        <span class="n">BOM</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\xef\xbb\xbf</span><span class="s">&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">BOM</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">BOM</span><span class="p">):]</span>
        
        <span class="c"># support fort \$ for backward-compatibility </span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">r&#39;\$&#39;</span><span class="p">,</span> <span class="s">&#39;$$&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span></div>
    <span class="n">normalize_text</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">normalize_text</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">__hidetraceback__</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="kn">import</span> <span class="nn">webapi</span> <span class="kn">as</span> <span class="nn">web</span>
        <span class="k">if</span> <span class="s">&#39;headers&#39;</span> <span class="ow">in</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">:</span>
            <span class="n">web</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">BaseTemplate</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        
<div class="viewcode-block" id="Template.generate_code"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.Template.generate_code">[docs]</a>    <span class="k">def</span> <span class="nf">generate_code</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># parse the text</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span> <span class="ow">or</span> <span class="n">Parser</span><span class="p">()</span>
        <span class="n">rootnode</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                
        <span class="c"># generate python code from the parse tree</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">rootnode</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">safestr</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        </div>
    <span class="n">generate_code</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">generate_code</span><span class="p">)</span>
    
<div class="viewcode-block" id="Template.create_parser"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.Template.create_parser">[docs]</a>    <span class="k">def</span> <span class="nf">create_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">ext</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>
</div>
<div class="viewcode-block" id="Template.compile_template"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.Template.compile_template">[docs]</a>    <span class="k">def</span> <span class="nf">compile_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_string</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">Template</span><span class="o">.</span><span class="n">generate_code</span><span class="p">(</span><span class="n">template_string</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_parser</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">get_source_line</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># compile the code first to report the errors, if any, with the filename</span>
            <span class="n">compiled_code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># display template line that caused the error along with the traceback.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">Template traceback:</span><span class="se">\n</span><span class="s">    File </span><span class="si">%s</span><span class="s">, line </span><span class="si">%s</span><span class="se">\n</span><span class="s">        </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">get_source_line</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">lineno</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="k">pass</span>
            <span class="k">raise</span>
        
        <span class="c"># make sure code is safe</span>
        <span class="kn">import</span> <span class="nn">compiler</span>
        <span class="n">ast</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">SafeVisitor</span><span class="p">()</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">compiled_code</span>
        </div></div>
<span class="k">class</span> <span class="nc">CompiledTemplate</span><span class="p">(</span><span class="n">Template</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">Template</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">f</span>
        
    <span class="k">def</span> <span class="nf">compile_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
                
<div class="viewcode-block" id="Render"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.Render">[docs]</a><span class="k">class</span> <span class="nc">Render</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The most preferred way of using templates.</span>
<span class="sd">    </span>
<span class="sd">        render = web.template.render(&#39;templates&#39;)</span>
<span class="sd">        print render.foo()</span>
<span class="sd">        </span>
<span class="sd">    Optional parameter can be `base` can be used to pass output of </span>
<span class="sd">    every template through the base template.</span>
<span class="sd">    </span>
<span class="sd">        render = web.template.render(&#39;templates&#39;, base=&#39;layout&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loc</span> <span class="o">=</span> <span class="n">loc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="n">keywords</span>

        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="k">if</span> <span class="n">base</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="c"># make base a function, so that it can be passed to sub-renders</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">page</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template</span><span class="p">(</span><span class="n">base</span><span class="p">)(</span><span class="n">page</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="o">=</span> <span class="n">base</span>

    <span class="k">def</span> <span class="nf">_add_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a global to this rendering instance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;globals&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">[</span><span class="s">&#39;globals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">[</span><span class="s">&#39;globals&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loc</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;dir&#39;</span><span class="p">,</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;file&#39;</span><span class="p">,</span> <span class="n">path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="bp">None</span>
        
    <span class="k">def</span> <span class="nf">_load_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">kind</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;dir&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Render</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_base</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;file&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">filename</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="s">&quot;No template named &quot;</span> <span class="o">+</span> <span class="n">name</span>            

    <span class="k">def</span> <span class="nf">_findfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_prefix</span><span class="p">):</span> 
        <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path_prefix</span> <span class="o">+</span> <span class="s">&#39;.*&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">)]</span> <span class="c"># skip backup files</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c"># sort the matches for deterministic order</span>
        <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
    <span class="k">def</span> <span class="nf">_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_template</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_template</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Template</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">template</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">template</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">GAE_Render</span><span class="p">(</span><span class="n">Render</span><span class="p">):</span>
    <span class="c"># Render gets over-written. make a copy here.</span>
    <span class="nb">super</span> <span class="o">=</span> <span class="n">Render</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">GAE_Render</span><span class="o">.</span><span class="n">super</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        
        <span class="kn">import</span> <span class="nn">types</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">loc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;builtins&#39;</span><span class="p">,</span> <span class="n">TEMPLATE_BUILTINS</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">Template</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;globals&#39;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">_load_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">types</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">GAE_Render</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_base</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t</span>

<span class="n">render</span> <span class="o">=</span> <span class="n">Render</span>
<span class="c"># setup render for Google App Engine.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">google</span> <span class="kn">import</span> <span class="n">appengine</span>
    <span class="n">render</span> <span class="o">=</span> <span class="n">Render</span> <span class="o">=</span> <span class="n">GAE_Render</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
        
<div class="viewcode-block" id="frender"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.frender">[docs]</a><span class="k">def</span> <span class="nf">frender</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a template from the given file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">filename</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>
    </div>
<span class="k">def</span> <span class="nf">compile_templates</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compiles templates to python code.&quot;&quot;&quot;</span>
    <span class="n">re_start</span> <span class="o">=</span> <span class="n">re_compile</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__init__.py&#39;</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">dirnames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="c"># don&#39;t visit this dir</span>

        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s">&#39;__init__.py&#39;</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;from web.template import CompiledTemplate, ForLoop, TemplateResult</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dirnames</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;import &quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirnames</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">f</span>
                
            <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">Template</span><span class="o">.</span><span class="n">normalize_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">Template</span><span class="o">.</span><span class="n">generate_code</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__template__&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = CompiledTemplate(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;join_ = </span><span class="si">%s</span><span class="s">._join; escape_ = </span><span class="si">%s</span><span class="s">._escape</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

            <span class="c"># create template to make sure it compiles</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
<div class="viewcode-block" id="ParseError"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.ParseError">[docs]</a><span class="k">class</span> <span class="nc">ParseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
    </div>
<div class="viewcode-block" id="SecurityError"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.SecurityError">[docs]</a><span class="k">class</span> <span class="nc">SecurityError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The template seems to be trying to do something naughty.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="c"># Enumerate all the allowed AST nodes</span></div>
<span class="n">ALLOWED_AST_NODES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;Add&quot;</span><span class="p">,</span> <span class="s">&quot;And&quot;</span><span class="p">,</span>
<span class="c">#   &quot;AssAttr&quot;,</span>
    <span class="s">&quot;AssList&quot;</span><span class="p">,</span> <span class="s">&quot;AssName&quot;</span><span class="p">,</span> <span class="s">&quot;AssTuple&quot;</span><span class="p">,</span>
<span class="c">#   &quot;Assert&quot;,</span>
    <span class="s">&quot;Assign&quot;</span><span class="p">,</span> <span class="s">&quot;AugAssign&quot;</span><span class="p">,</span>
<span class="c">#   &quot;Backquote&quot;,</span>
    <span class="s">&quot;Bitand&quot;</span><span class="p">,</span> <span class="s">&quot;Bitor&quot;</span><span class="p">,</span> <span class="s">&quot;Bitxor&quot;</span><span class="p">,</span> <span class="s">&quot;Break&quot;</span><span class="p">,</span>
    <span class="s">&quot;CallFunc&quot;</span><span class="p">,</span><span class="s">&quot;Class&quot;</span><span class="p">,</span> <span class="s">&quot;Compare&quot;</span><span class="p">,</span> <span class="s">&quot;Const&quot;</span><span class="p">,</span> <span class="s">&quot;Continue&quot;</span><span class="p">,</span>
    <span class="s">&quot;Decorators&quot;</span><span class="p">,</span> <span class="s">&quot;Dict&quot;</span><span class="p">,</span> <span class="s">&quot;Discard&quot;</span><span class="p">,</span> <span class="s">&quot;Div&quot;</span><span class="p">,</span>
    <span class="s">&quot;Ellipsis&quot;</span><span class="p">,</span> <span class="s">&quot;EmptyNode&quot;</span><span class="p">,</span>
<span class="c">#   &quot;Exec&quot;,</span>
    <span class="s">&quot;Expression&quot;</span><span class="p">,</span> <span class="s">&quot;FloorDiv&quot;</span><span class="p">,</span> <span class="s">&quot;For&quot;</span><span class="p">,</span>
<span class="c">#   &quot;From&quot;,</span>
    <span class="s">&quot;Function&quot;</span><span class="p">,</span> 
    <span class="s">&quot;GenExpr&quot;</span><span class="p">,</span> <span class="s">&quot;GenExprFor&quot;</span><span class="p">,</span> <span class="s">&quot;GenExprIf&quot;</span><span class="p">,</span> <span class="s">&quot;GenExprInner&quot;</span><span class="p">,</span>
    <span class="s">&quot;Getattr&quot;</span><span class="p">,</span> 
<span class="c">#   &quot;Global&quot;, </span>
    <span class="s">&quot;If&quot;</span><span class="p">,</span> <span class="s">&quot;IfExp&quot;</span><span class="p">,</span>
<span class="c">#   &quot;Import&quot;,</span>
    <span class="s">&quot;Invert&quot;</span><span class="p">,</span> <span class="s">&quot;Keyword&quot;</span><span class="p">,</span> <span class="s">&quot;Lambda&quot;</span><span class="p">,</span> <span class="s">&quot;LeftShift&quot;</span><span class="p">,</span>
    <span class="s">&quot;List&quot;</span><span class="p">,</span> <span class="s">&quot;ListComp&quot;</span><span class="p">,</span> <span class="s">&quot;ListCompFor&quot;</span><span class="p">,</span> <span class="s">&quot;ListCompIf&quot;</span><span class="p">,</span> <span class="s">&quot;Mod&quot;</span><span class="p">,</span>
    <span class="s">&quot;Module&quot;</span><span class="p">,</span>
    <span class="s">&quot;Mul&quot;</span><span class="p">,</span> <span class="s">&quot;Name&quot;</span><span class="p">,</span> <span class="s">&quot;Not&quot;</span><span class="p">,</span> <span class="s">&quot;Or&quot;</span><span class="p">,</span> <span class="s">&quot;Pass&quot;</span><span class="p">,</span> <span class="s">&quot;Power&quot;</span><span class="p">,</span>
<span class="c">#   &quot;Print&quot;, &quot;Printnl&quot;, &quot;Raise&quot;,</span>
    <span class="s">&quot;Return&quot;</span><span class="p">,</span> <span class="s">&quot;RightShift&quot;</span><span class="p">,</span> <span class="s">&quot;Slice&quot;</span><span class="p">,</span> <span class="s">&quot;Sliceobj&quot;</span><span class="p">,</span>
    <span class="s">&quot;Stmt&quot;</span><span class="p">,</span> <span class="s">&quot;Sub&quot;</span><span class="p">,</span> <span class="s">&quot;Subscript&quot;</span><span class="p">,</span>
<span class="c">#   &quot;TryExcept&quot;, &quot;TryFinally&quot;,</span>
    <span class="s">&quot;Tuple&quot;</span><span class="p">,</span> <span class="s">&quot;UnaryAdd&quot;</span><span class="p">,</span> <span class="s">&quot;UnarySub&quot;</span><span class="p">,</span>
    <span class="s">&quot;While&quot;</span><span class="p">,</span> <span class="s">&quot;With&quot;</span><span class="p">,</span> <span class="s">&quot;Yield&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">SafeVisitor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure code is safe by walking through the AST.</span>
<span class="sd">    </span>
<span class="sd">    Code considered unsafe if:</span>
<span class="sd">        * it has restricted AST nodes</span>
<span class="sd">        * it is trying to access resricted attributes   </span>
<span class="sd">        </span>
<span class="sd">    Adopted from http://www.zafar.se/bkz/uploads/safe.txt (public domain, Babar K. Zafar)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Initialize visitor by generating callbacks for all AST node types.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s">&quot;Validate each node in AST and raise SecurityError if the code is not safe.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>        
            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="s">&quot;Recursively validate node and all of its children.&quot;</span>
        <span class="k">def</span> <span class="nf">classname</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">nodename</span> <span class="o">=</span> <span class="n">classname</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;visit&#39;</span> <span class="o">+</span> <span class="n">nodename</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nodename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_AST_NODES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">getChildNodes</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="s">&quot;Disallow any attempts to access a restricted attr.&quot;</span>
        <span class="c">#self.assert_attr(node.getChildren()[0], node)</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">visitGetattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="s">&quot;Disallow any attempts to access a restricted attribute.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_attr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrname</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">assert_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_unallowed_attr</span><span class="p">(</span><span class="n">attrname</span><span class="p">):</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_node_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s"> - access to attribute &#39;</span><span class="si">%s</span><span class="s">&#39; is denied&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">attrname</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_unallowed_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;func_&#39;</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;im_&#39;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">get_node_lineno</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span> <span class="ow">or</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="s">&quot;Default callback for unallowed AST nodes.&quot;</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_node_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">nodename</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s"> - execution of &#39;</span><span class="si">%s</span><span class="s">&#39; statements is denied&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">nodename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TemplateResult</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">DictMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dictionary like object for storing template output.</span>
<span class="sd">    </span>
<span class="sd">    A template can specify key-value pairs in the output using </span>
<span class="sd">    `var` statements. Each `var` statement adds a new key to the </span>
<span class="sd">    template output and the main output is stored with key </span>
<span class="sd">    __body__.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; d = TemplateResult(__body__=&#39;hello, world&#39;, x=&#39;foo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; d</span>
<span class="sd">        &lt;TemplateResult: {&#39;__body__&#39;: &#39;hello, world&#39;, &#39;x&#39;: &#39;foo&#39;}&gt;</span>
<span class="sd">        &gt;&gt;&gt; print d</span>
<span class="sd">        hello, world</span>
<span class="sd">        &gt;&gt;&gt; d = TemplateResult()</span>
<span class="sd">        &gt;&gt;&gt; d.extend([u&#39;hello&#39;, u&#39;world&#39;])</span>
<span class="sd">        &gt;&gt;&gt; d</span>
<span class="sd">        &lt;TemplateResult: {&#39;__body__&#39;: u&#39;helloworld&#39;}&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&quot;__body__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c"># avoiding self._data because it adds as item instead of attr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;extend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">extend</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;__body__&quot;</span> <span class="ow">and</span> <span class="n">storage</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;__body__&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&quot;__body__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">storage</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s">&quot;__body__&quot;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s">&quot;__body__&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&quot;__body__&quot;</span><span class="p">]</span> <span class="c"># initialize __body__ if not already initialized</span>
        <span class="k">return</span> <span class="s">&quot;&lt;TemplateResult: </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="test"><a class="viewcode-back" href="../../../modules/lib.web.html#lib.web.template.test">[docs]</a><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;Doctest for testing template module.</span>

<span class="sd">    Define a utility function to run template test.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; class TestResult:</span>
<span class="sd">        ...     def __init__(self, t): self.t = t</span>
<span class="sd">        ...     def __getattr__(self, name): return getattr(self.t, name)</span>
<span class="sd">        ...     def __repr__(self): return repr(unicode(self))</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; def t(code, **keywords):</span>
<span class="sd">        ...     tmpl = Template(code, **keywords)</span>
<span class="sd">        ...     return lambda *a, **kw: TestResult(tmpl(*a, **kw))</span>
<span class="sd">        ...</span>
<span class="sd">    </span>
<span class="sd">    Simple tests.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with ()\n1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (a)\n$a&#39;)(1)</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (a=0)\n$a&#39;)(1)</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (a=0)\n$a&#39;)(a=1)</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">    </span>
<span class="sd">    Test complicated expressions.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (x)\n$x.upper()&#39;)(&#39;hello&#39;)</span>
<span class="sd">        u&#39;HELLO\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$(2 * 3 + 4 * 5)&#39;)()</span>
<span class="sd">        u&#39;26\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;${2 * 3 + 4 * 5}&#39;)()</span>
<span class="sd">        u&#39;26\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (limit)\nkeep $(limit)ing.&#39;)(&#39;go&#39;)</span>
<span class="sd">        u&#39;keep going.\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (a)\n$a.b[0]&#39;)(storage(b=[1]))</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        </span>
<span class="sd">    Test html escaping.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (x)\n$x&#39;, filename=&#39;a.html&#39;)(&#39;&lt;html&gt;&#39;)</span>
<span class="sd">        u&#39;&amp;lt;html&amp;gt;\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (x)\n$x&#39;, filename=&#39;a.txt&#39;)(&#39;&lt;html&gt;&#39;)</span>
<span class="sd">        u&#39;&lt;html&gt;\n&#39;</span>
<span class="sd">                </span>
<span class="sd">    Test if, for and while.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$if 1: 1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$if 1:\n    1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$if 1:\n    1\\&#39;)()</span>
<span class="sd">        u&#39;1&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$if 0: 0\n$elif 1: 1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$if 0: 0\n$elif None: 0\n$else: 1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$if 0 &lt; 1 and 1 &lt; 2: 1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$for x in [1, 2, 3]: $x&#39;)()</span>
<span class="sd">        u&#39;1\n2\n3\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (d)\n$for k, v in d.iteritems(): $k&#39;)({1: 1})</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$for x in [1, 2, 3]:\n\t$x&#39;)()</span>
<span class="sd">        u&#39;    1\n    2\n    3\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (a)\n$while a and a.pop():1&#39;)([1, 2, 3])</span>
<span class="sd">        u&#39;1\n1\n1\n&#39;</span>

<span class="sd">    The space after : must be ignored.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$if True: foo&#39;)()</span>
<span class="sd">        u&#39;foo\n&#39;</span>
<span class="sd">    </span>
<span class="sd">    Test loop.xxx.</span>

<span class="sd">        &gt;&gt;&gt; t(&quot;$for i in range(5):$loop.index, $loop.parity&quot;)()</span>
<span class="sd">        u&#39;1, odd\n2, even\n3, odd\n4, even\n5, odd\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&quot;$for i in range(2):\n    $for j in range(2):$loop.parent.parity $loop.parity&quot;)()</span>
<span class="sd">        u&#39;odd odd\nodd even\neven odd\neven even\n&#39;</span>
<span class="sd">        </span>
<span class="sd">    Test assignment.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ a = 1\n$a&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ a = [1]\n$a[0]&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ a = {1: 1}\n$a.keys()[0]&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ a = []\n$if not a: 1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ a = {}\n$if not a: 1&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ a = -1\n$a&#39;)()</span>
<span class="sd">        u&#39;-1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ a = &quot;1&quot;\n$a&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>

<span class="sd">    Test comments.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$# 0&#39;)()</span>
<span class="sd">        u&#39;\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;hello$#comment1\nhello$#comment2&#39;)()</span>
<span class="sd">        u&#39;hello\nhello\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$#comment0\nhello$#comment1\nhello$#comment2&#39;)()</span>
<span class="sd">        u&#39;\nhello\nhello\n&#39;</span>
<span class="sd">        </span>
<span class="sd">    Test unicode.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (a)\n$a&#39;)(u&#39;\u203d&#39;)</span>
<span class="sd">        u&#39;\u203d\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (a)\n$a&#39;)(u&#39;\u203d&#39;.encode(&#39;utf-8&#39;))</span>
<span class="sd">        u&#39;\u203d\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(u&#39;$def with (a)\n$a $:a&#39;)(u&#39;\u203d&#39;)</span>
<span class="sd">        u&#39;\u203d \u203d\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(u&#39;$def with ()\nfoo&#39;)()</span>
<span class="sd">        u&#39;foo\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; def f(x): return x</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; t(u&#39;$def with (f)\n$:f(&quot;x&quot;)&#39;)(f)</span>
<span class="sd">        u&#39;x\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (f)\n$:f(&quot;x&quot;)&#39;)(f)</span>
<span class="sd">        u&#39;x\n&#39;</span>
<span class="sd">    </span>
<span class="sd">    Test dollar escaping.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&quot;Stop, $$money isn&#39;t evaluated.&quot;)()</span>
<span class="sd">        u&quot;Stop, $money isn&#39;t evaluated.\n&quot;</span>
<span class="sd">        &gt;&gt;&gt; t(&quot;Stop, \$money isn&#39;t evaluated.&quot;)()</span>
<span class="sd">        u&quot;Stop, $money isn&#39;t evaluated.\n&quot;</span>
<span class="sd">        </span>
<span class="sd">    Test space sensitivity.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with (x)\n$x&#39;)(1)</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$def with(x ,y)\n$x&#39;)(1, 1)</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$(1 + 2*3 + 4)&#39;)()</span>
<span class="sd">        u&#39;11\n&#39;</span>
<span class="sd">        </span>
<span class="sd">    Make sure globals are working.</span>
<span class="sd">            </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$x&#39;)()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        NameError: global name &#39;x&#39; is not defined</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$x&#39;, globals={&#39;x&#39;: 1})()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        </span>
<span class="sd">    Can&#39;t change globals.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ x = 2\n$x&#39;, globals={&#39;x&#39;: 1})()</span>
<span class="sd">        u&#39;2\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$ x = x + 1\n$x&#39;, globals={&#39;x&#39;: 1})()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        UnboundLocalError: local variable &#39;x&#39; referenced before assignment</span>
<span class="sd">    </span>
<span class="sd">    Make sure builtins are customizable.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$min(1, 2)&#39;)()</span>
<span class="sd">        u&#39;1\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&#39;$min(1, 2)&#39;, builtins={})()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        NameError: global name &#39;min&#39; is not defined</span>
<span class="sd">        </span>
<span class="sd">    Test vars.</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; x = t(&#39;$var x: 1&#39;)()</span>
<span class="sd">        &gt;&gt;&gt; x.x</span>
<span class="sd">        u&#39;1&#39;</span>
<span class="sd">        &gt;&gt;&gt; x = t(&#39;$var x = 1&#39;)()</span>
<span class="sd">        &gt;&gt;&gt; x.x</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; x = t(&#39;$var x:  \n    foo\n    bar&#39;)()</span>
<span class="sd">        &gt;&gt;&gt; x.x</span>
<span class="sd">        u&#39;foo\nbar\n&#39;</span>

<span class="sd">    Test BOM chars.</span>

<span class="sd">        &gt;&gt;&gt; t(&#39;\xef\xbb\xbf$def with(x)\n$x&#39;)(&#39;foo&#39;)</span>
<span class="sd">        u&#39;foo\n&#39;</span>

<span class="sd">    Test for with weird cases.</span>

<span class="sd">        &gt;&gt;&gt; t(&#39;$for i in range(10)[1:5]:\n    $i&#39;)()</span>
<span class="sd">        u&#39;1\n2\n3\n4\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&quot;$for k, v in {&#39;a&#39;: 1, &#39;b&#39;: 2}.items():\n    $k $v&quot;)()</span>
<span class="sd">        u&#39;a 1\nb 2\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; t(&quot;$for k, v in ({&#39;a&#39;: 1, &#39;b&#39;: 2}.items():\n    $k $v&quot;)()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        SyntaxError: invalid syntax</span>

<span class="sd">    Test datetime.</span>

<span class="sd">        &gt;&gt;&gt; import datetime</span>
<span class="sd">        &gt;&gt;&gt; t(&quot;$def with (date)\n$date.strftime(&#39;%m %Y&#39;)&quot;)(datetime.datetime(2009, 1, 1))</span>
<span class="sd">        u&#39;01 2009\n&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
            </div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">if</span> <span class="s">&#39;--compile&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="n">compile_templates</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">doctest</span>
        <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Change by Us v2.0-alpha documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Local Projects and Code for America.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>